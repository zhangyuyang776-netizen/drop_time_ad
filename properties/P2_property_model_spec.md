# P2 物性与界面平衡模型定稿约束文件（T/P 依赖 + 公式族 + 护栏）

> 目标：彻底移除 CoolProp 后，用一套**可配置的经验关联式（correlations）**计算液相物性与界面饱和/平衡量，并通过**沸点护栏**避免界面温度跨越沸点导致数值发散。
>
> 适用前提：
> - 气相：理想气体（用 Cantera 计算气相物性与化学）。
> - 液相：先采用“弱可压缩液体”近似，绝大多数液相物性仅随温度变化（T-only）。
> - 界面平衡：先采用理想气体 + Raoult（γ=1，φ=1），在此基础上加**守恒与饱和约束**。

---

## 1. 变量依赖结论：哪些只依赖 T，哪些必须依赖 (T, P)

### 1.1 默认（P2 第一版）推荐依赖关系

| 量 | 符号 | 默认自变量 | 是否建议考虑 P | 说明 |
|---|---:|---|---|---|
| 饱和蒸汽压 | \(p^{sat}(T)\) | **T** | 否 | 纯物性关联式；通过它反解沸点 \(T_b(P)\) |
| 沸点（定义量） | \(T_b(P)\) | **P**（通过反解 psat） | 是 | 由 \(p^{sat}(T_b)=P\) 定义；用于界面温度护栏 |
| 汽化潜热 | \(\Delta h_{vap}(T)\) | **T** | 否（默认） | 常用关联式仅与 T（或 \(T/T_c\)）有关 |
| 液相密度 | \(\rho_l(T)\) | **T** | 可选 | 默认忽略液体可压缩性；若要 Poynting/高压可补 |
| 液相比热 | \(c_{p,l}(T)\) | **T** | 否 | 经验式通常仅依赖 T |
| 液相黏度 | \(\mu_l(T)\) | **T** | 否 | 经验式通常仅依赖 T |
| 液相导热系数 | \(k_l(T)\) | **T** | 否 | 经验式通常仅依赖 T |
| 表面张力 | \(\sigma(T)\) | **T** | 否 | 常用临界缩放型 |
| 液相摩尔体积 | \(v_l(T)\) | **T** | 可选 | \(v_l=M/\rho_l\)；若启用 Poynting 修正会用到 |
| 界面气相平衡组成 | \(x_{g,i}\) 或 \(y_{g,i}\) | **T + P + x_{l,i}** | 必须 | 由 Raoult/饱和约束决定，必须含总压 P |

**结论：**
- **液相 bulk 物性**在 P2 第一版可以全部做成 **T-only**。
- **界面平衡与饱和约束**必然是 **(T, P)**（至少通过 \(p^{sat}(T)/P\) 或 \(T_b(P)\)）。

### 1.2 何时必须考虑压力效应（后续可选增强）
当满足以下任一条件，建议把部分液相物性扩展为 \(f(T,P)\)：
- 高压（例如 \(P\gg 10\) atm），液体可压缩性导致 \(\rho_l\) 与 \(v_l\) 对 P 敏感；
- 你启用 **Poynting 修正**：\(\exp\left(\int (v_l/RT)\,dP\right)\)；
- 你未来启用非理想气相（\(\phi\neq 1\)）或非理想液相（\(\gamma\neq 1\)）。

P2 定稿范围内**先不做**上述增强，只保留接口占位。

---

## 2. 统一单位约定（必须写死）

- 温度 \(T\)：K
- 压力 \(P\)、\(p^{sat}\)：Pa
- 密度 \(\rho\)：kg/m³
- 比热 \(c_p\)：J/(kg·K)
- 黏度 \(\mu\)：Pa·s
- 导热系数 \(k\)：W/(m·K)
- 表面张力 \(\sigma\)：N/m
- 汽化潜热 \(\Delta h_{vap}\)：J/kg
- 气相组成：优先用摩尔分数 \(x_g\) 做平衡；与质量分数 \(Y_g\) 的转换见第 6 节。

---

## 3. 物性关联式（公式族）定稿：每个量的“标准公式形态”

> 原则：每个量 **只选一种默认公式族**（避免后续“同一量多种公式混用”的维护灾难）。
> 若要支持多种模型，放在 `model:` 字段切换，但**默认只启用一种**。

### 3.1 饱和蒸汽压 \(p^{sat}(T)\)

**默认：Wagner-25（推荐，靠近临界更稳）**

\[
\ln\left(\frac{p^{sat}}{P_c}\right)
=\frac{1}{T_r}\left(a\,\tau + b\,\tau^{1.5}+c\,\tau^3+d\,\tau^6\right),
\quad T_r=\frac{T}{T_c},\ \tau=1-T_r
\]

**所需参数（每物种）：** \(T_c, P_c, a,b,c,d\) + 有效温区 \([T_{min},T_{max}]\)

**备选（若你已有 Yaws lnP 形式系数）：Yaws/DIPPR101 对数式**

\[
\ln p^{sat}=A+\frac{B}{T}+C\ln T + D\,T^E
\]

**所需参数：** \(A,B,C,D,E\) + \([T_{min},T_{max}]\)

> 约束：必须保证 \(p^{sat}(T)\) 在有效温区内**单调递增**（用诊断断言/测试保证）。

---

### 3.2 沸点 \(T_b(P)\)（定义量，用于护栏）

**定义：** 由方程求根
\[
F(T)=p^{sat}(T)-P=0
\]

**数值求解要求：**
- 使用**二分法**或 bracketed Newton（必须有 bracket），保证稳健；
- 需要一个可行的温度括区 \([T_{low},T_{high}]\)（通常用物种的 \(T_{min},T_{max}\) 或更窄的工程温区）；
- 若 \(P\) 超出 psat 在温区内的可达范围，必须返回可诊断错误（而不是 NaN）。

---

### 3.3 汽化潜热 \(\Delta h_{vap}(T)\)

**默认：Watson correlation**
\[
\Delta h_{vap}(T)=\Delta h_{vap}(T_{ref})\left(\frac{1-T/T_c}{1-T_{ref}/T_c}\right)^n
\]

**所需参数：** \(T_c\)、参考点 \(T_{ref}\)（建议取 1 atm 沸点 \(T_b\)）对应的 \(\Delta h_{vap}(T_{ref})\)、指数 \(n\)

**约束：**
- \(T\to T_c\) 时 \(\Delta h_{vap}\to 0\)；
- 若计算得到负值或 NaN，必须触发护栏（见第 5 节）。

---

### 3.4 液相密度 \(\rho_l(T)\)

**默认：Rackett 型（工程常用）**
\[
\rho_l(T)=\rho_c\,Z_{RA}^{-\left(1-T/T_c\right)^{2/7}}
\]

> Rackett 方程存在多种等价写法（质量密度/摩尔密度版本不同）。P2 定稿要求：
> - 你必须在实现中**写死一种具体形式**，并明确参数的物理含义与单位。

**所需参数：** \(T_c\)、\(\rho_c\)（或 \(d_c\)）、\(Z_{RA}\) + \([T_{min},T_{max}]\)

**备选（快速可用）：多项式（仅用于初期过渡，不建议长期保留）**
\[
\rho_l(T)=a_0+a_1T+a_2T^2+a_3T^3
\]

---

### 3.5 液相比热 \(c_{p,l}(T)\)

**默认：多项式**
\[
c_{p,l}(T)=a_0+a_1T+a_2T^2+a_3T^3+a_4T^4
\]

**所需参数：** \(a_0\ldots a_4\) + \([T_{min},T_{max}]\)

---

### 3.6 液相黏度 \(\mu_l(T)\)

**默认：对数型（保证正值）**
\[
\ln \mu_l = A+\frac{B}{T}+C\ln T + D\,T^E
\]

**所需参数：** \(A,B,C,D,E\) + \([T_{min},T_{max}]\)

---

### 3.7 液相导热系数 \(k_l(T)\)

**默认：低阶多项式**
\[
k_l(T)=a_0+a_1T+a_2T^2
\]

**所需参数：** \(a_0,a_1,a_2\) + \([T_{min},T_{max}]\)

---

### 3.8 表面张力 \(\sigma(T)\)（若你的模型用到）

**默认：临界缩放幂律**
\[
\sigma(T)=A\left(1-\frac{T}{T_c}\right)^n
\]

**所需参数：** \(T_c\)、\(A\)、\(n\) + \([T_{min},T_{max}]\)

---

## 4. 界面平衡计算（理想气体 + Raoult）定稿

### 4.1 单组分液滴（最常用、最稳）

- 先计算 \(T_b(P)\)，然后做界面温度护栏得到 \(T_s^{eff}\)（见第 5 节）。
- 平衡（摩尔分数）：
\[
 x_{g,f}=\min\left(\frac{p^{sat}(T_s^{eff})}{P},\ 1-\epsilon\right)
\]
- 若你内部使用质量分数：先算 \(x_{g}\)，再按第 6 节转为 \(Y_g\)。

### 4.2 多组分液滴（理想溶液）

对挥发组分集合 \(\mathcal{V}\)：
\[
 x_{g,i}=\frac{x_{l,i}\,p_i^{sat}(T_s^{eff})}{P},\quad i\in\mathcal{V}
\]

**总和约束护栏：**
- 若 \(S=\sum_{i\in\mathcal{V}} x_{g,i} > 1-\epsilon\)，按比例缩放：
\[
 x_{g,i}\leftarrow x_{g,i}\,\frac{1-\epsilon}{S}
\]
- 其余（非挥发/闭合）气相摩尔分数：
\[
 x_{g,\text{rest}} = 1-\sum_{i\in\mathcal{V}} x_{g,i}
\]

> 说明：这是一条工程护栏，目的是确保界面气相组成合法且不会把求解器推爆。

---

## 5. 护栏与截断（必须定稿，不允许“边写边加”）

### 5.1 温区护栏（所有关联式共用）

对每个物性函数 \(q(T)\)：
- 若 \(T < T_{min}\)：使用 \(T_{min}\) 代入并记录 `clamp_low=True`
- 若 \(T > T_{max}\)：使用 \(T_{max}\) 代入并记录 `clamp_high=True`
- 输出必须保证有限值（finite），否则返回可诊断错误并触发上层回退/阻尼。

### 5.2 沸点护栏（核心）

给定当前总压 \(P\)，先求 \(T_b(P)\)。然后定义：

**硬护栏（默认，最稳）：**
\[
T_s^{eff}=\min(T_s,\ T_b(P)-\Delta T_{guard})
\]

推荐：\(\Delta T_{guard}=0.5\text{ K}\)（可配置）

**软护栏（可选，导数更平滑）：** 用 softplus/tanh 形式实现 \(T_s^{eff}\le T_b\)，但 P2 默认先不用。

### 5.3 组成护栏

- 任何摩尔分数/质量分数必须满足 \([0,1]\)；
- 总和必须为 1（允许 \(\pm 1e-12\) 数值误差）；
- 必须保留一个小 \(\epsilon\)（默认 \(1e-12\) 或 \(1e-10\)），避免出现 exactly 1 导致除零/对数发散。

### 5.4 汽化潜热护栏

- 若 \(\Delta h_{vap}(T)\le 0\) 或 NaN：
  - 先 clamp 到 \(T\le T_c-\Delta T\)
  - 若仍异常：抛出可诊断错误（不要静默返回 0）

---

## 6. 摩尔分数与质量分数转换（界面必用）

给定摩尔分数 \(x_i\) 与分子量 \(W_i\)：
\[
Y_i = \frac{x_i W_i}{\sum_j x_j W_j}
\]

给定质量分数 \(Y_i\)：
\[
x_i = \frac{Y_i/W_i}{\sum_j Y_j/W_j}
\]

> 注意：若存在“闭合物种”（如 N2），必须保证组成向量在转换前后总和为 1。

---

## 7. 物性参数文件（YAML）定稿 schema

> 每个液体物种一段，所有系数都在这里给出，代码只实现公式模板。

```yaml
liquids:
  NC12H26:
    MW: 170.33484
    Tc: 658.2
    Pc: 1.82e6
    Tb_1atm: 489.5

    psat:
      model: wagner25   # 或 yaws_lnP
      Tmin: 250.0
      Tmax: 650.0
      coeffs:
        a: ...
        b: ...
        c: ...
        d: ...

    hvap:
      model: watson
      Tref: 489.5
      Hvap_Tref: ...     # J/kg
      n: 0.38

    rho:
      model: rackett
      Tmin: 250.0
      Tmax: 650.0
      coeffs:
        rho_c: ...        # kg/m3
        Z_RA: ...

    cp:
      model: poly4
      Tmin: 250.0
      Tmax: 650.0
      coeffs: [a0, a1, a2, a3, a4]

    mu:
      model: yaws_ln
      Tmin: 250.0
      Tmax: 650.0
      coeffs: [A, B, C, D, E]

    k:
      model: poly2
      Tmin: 250.0
      Tmax: 650.0
      coeffs: [a0, a1, a2]

    sigma:
      model: crit_power
      Tmin: 250.0
      Tmax: 650.0
      coeffs:
        A: ...
        n: ...
```

---

## 8. 最小验收（P2 写完公式后立刻做，不接主求解器也要做）

1) **单调性**：对每个物种在工作温区内验证 \(p^{sat}(T)\) 单调递增。
2) **沸点反解**：对 P=1/5/10 atm 能求出 \(T_b(P)\)，且 \(p^{sat}(T_b)\approx P\)。
3) **有限性**：所有输出无 NaN/inf。
4) **护栏触发**：当 \(T_s > T_b\) 时，`Ts_eff` 被压到 \(T_b-ΔT_guard\)，并且界面组成仍合法。

---

## 9. 备注：与 Cuoci 2024 / Yaws 的关系

- Cuoci 2024 的实现路线是：液相物性与饱和量使用 **Yaws 数据库关联式**（correlations）。
- 本文件将其具体化为“可配置关联式模板 + 每物种系数文件”的工程实现形式，便于在不依赖 CoolProp 的情况下重现同类行为。

