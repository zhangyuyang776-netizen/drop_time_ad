# Example configuration showing how to enable u vector spatial output
#
# This case demonstrates the new spatial output features:
# - Unified output directory structure: 3D_out/case_xxx/run_yyy/
# - mapping.json: describes u vector layout
# - steps/*.npz: u vector + grid coordinates for each time step
# - Post-processing: convert npz to CSV using scripts/postprocess_u_to_csv.py

case:
  id: example_u_output
  title: "Example: u vector spatial output demo"
  version: 2
  notes: "Demonstrates new spatial output features with u vector and grid coordinates"

paths:
  output_root: "3D_out"  # Unified output root (default: "3D_out")
  case_dir: "out/example_u_output"  # Legacy output (if needed)
  mechanism_dir: "mechanism"
  gas_mech: "gas_minimal.yaml"

conventions:
  radial_normal: "+er"
  flux_sign: "outward_positive"
  heat_flux_def: "q=-k*dTdr"
  evap_sign: "mpp_positive_evaporation"
  gas_closure_species: "N2"
  index_source: "unknown_layout_only"
  assembly_pure: true
  grid_state_props_split: true

physics:
  model: "droplet_1d_spherical_noChem"
  enable_liquid: true
  include_chemistry: false
  solve_Tg: true
  solve_Yg: true
  solve_Tl: true
  solve_Yl: false
  include_Ts: false
  include_mpp: true
  include_Rd: true
  stefan_velocity: true

  interface:
    type: "no_condensation"
    bc_mode: "Ts_fixed"
    Ts_fixed: 300.0
    equilibrium:
      method: "raoult_psat"
      psat_model: "coolprop"
      condensables_gas: ["NC12H26"]
      coolprop:
        backend: "HEOS"
        fluids: ["n-Dodecane"]

species:
  gas_balance_species: "N2"
  gas_mechanism_phase: "gas"
  liq_species: ["n-Dodecane"]
  liq_balance_species: "n-Dodecane"
  liq2gas_map:
    n-Dodecane: "NC12H26"
  mw_kg_per_mol:
    n-Dodecane: 0.17034
  molar_volume_cm3_per_mol:
    n-Dodecane: 227.51

geometry:
  a0: 1.0e-4
  R_inf: 1.0e-2
  N_liq: 10
  N_gas: 100
  mesh:
    liq_method: "tanh"
    liq_beta: 2.0
    liq_center_bias: 0.4
    gas_method: "tanh"
    gas_beta: 2.0
    gas_center_bias: -0.4
    enforce_interface_continuity: true
    continuity_tol: 1.0e-12

time:
  t0: 0.0
  dt: 1.0e-6
  t_end: 1.0e-4  # Short run for demo
  max_steps: null

discretization:
  time_scheme: "BE"
  theta: 1.0
  mass_matrix: "rhoVc_p"

initial:
  T_inf: 1100.0
  P_inf: 101325.0
  T_d0: 300.0
  Yg: {"N2": 1.0}
  Yl: {"n-Dodecane": 1.0}
  Y_seed: 1.0e-12

petsc:
  options_prefix: "droplet_"
  ksp_type: "gmres"
  pc_type: "ilu"
  rtol: 1.0e-8
  atol: 1.0e-12
  max_it: 200
  restart: 50
  monitor: true

io:
  write_every: 10  # Legacy spatial output frequency
  scalars_write_every: 1  # Scalar CSV output frequency
  formats: ["csv", "npz"]
  save_grid: true
  fields:
    scalars: ["t", "Ts", "mpp", "Rd"]
    gas: ["Tg", "Yg"]
    liquid: ["Tl", "Yl"]

# NEW: u vector spatial output configuration
output:
  u_enabled: true    # Enable u vector spatial output
  u_every: 5         # Write every 5 steps (reduce file count)
  # Note: Can also use environment variable DROPLET_WRITE_U=1 to force enable

checks:
  enforce_sumY: true
  sumY_tol: 1.0e-10
  clamp_negative_Y: true
  min_Y: 0.0
  enforce_T_bounds: true
  T_min: 200.0
  T_max: 4000.0
  enforce_unique_index: true
  enforce_grid_state_props_split: true
  enforce_assembly_purity: true

# Post-processing instructions:
# After running this case, you can convert the npz files to CSV using:
#
#   python scripts/postprocess_u_to_csv.py \
#       --run-dir 3D_out/case_example_u_output/run_YYYYMMDD_HHMMSS_pidXXXX \
#       --stride 2 \
#       --t-start 0 \
#       --t-end 1e-4
#
# This will create CSV files in 3D_out/.../run_.../post_csv/
# Each CSV contains:
# - Header: phase, r, T, Y_<species1>, Y_<species2>, ...
# - Rows: gas phase first, then liquid phase
# - Scalars (Ts, mpp, Rd) as comments at the top
